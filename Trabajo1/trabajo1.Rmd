---
title: "Trabajo 1 Tae"
author: "Camila Acosta Ramírez"
date: "13/10/2020"
output: html_document
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(dummies)
library(stringr)
library(dplyr)
library(lubridate)
library(ggplot2)
library(GGally)
library(car)
library(MLmetrics)
library(wordcloud)
library(gplots)
library(R.utils)
```

```{r echo=FALSE}
# Función para Calcular el R2 en Modelos lineales generalizados
custom_R2 <- function(glm){
  return((glm$null.deviance - glm$deviance)/ glm$null.deviance) 
}
```


```{r echo=FALSE}
datos_2014 <- read.csv("./BasesDeDatos/Incidentes_georreferenciados_2014.csv", 
                       sep = ",", encoding = "UTF-8")
datos_2015 <- read.csv("./BasesDeDatos/Incidentes_georreferenciados_2015.csv", 
                       header = T, sep = ",", encoding = "UTF-8")
datos_2016 <- read.csv("./BasesDeDatos/Incidentes_georreferenciados__2016.csv", 
                       header = T, sep = ",", encoding = "UTF-8")
datos_2017 <- read.csv("./BasesDeDatos/Incidentes_georreferenciados_2017.csv", 
                       header = T, sep = ",", encoding = "UTF-8")
datos_2018 <- read.csv("./BasesDeDatos/Incidentes_georreferenciados_2018.csv", 
                       header = T, sep = ",", encoding = "UTF-8")
holidays <- read.csv("./BasesDeDatos/holidays.csv", header = T, sep=",", encoding = "UTF-8")

```

```{r}
#UNION DE BASES
datos <- rbind(datos_2014,datos_2015, datos_2016, datos_2017)

#ELIMINAR COLUMNAS INNECESARIAS
datos <- datos[,-c(1,2,4,22,21)]

#ARREGLO DE VARIABLE GRAVEDAD
datos$GRAVEDAD <- as.factor(datos$GRAVEDAD)

#ARREGLO VARIABLE CLASE
datos$CLASE <- str_replace_all(datos$CLASE,"^\\s|\\s$", "")
datos$CLASE <- str_replace_all(datos$CLASE, "Ca(í|i)da d?e? ?Ocupante", 
                               "Caída Ocupante")
datos[datos$CLASE == "",6] <- "Otro"
datos$CLASE <- str_replace_all(datos$CLASE, "Choque y Atropello", 
                               "Otro")
datos$CLASE <- as.factor(datos$CLASE)

#ARREGLO VARIABLE BARRIO
datos$BARRIO <- str_replace_all(datos$BARRIO, "(.\\sNo\\.)\\s?(\\d)$", 
                                "\\1\\2")
datos$BARRIO <- str_replace_all(datos$BARRIO, "B. Cerro ? ?El Volador", 
                                "B. Cerro El Volador")
datos$BARRIO <- str_replace_all(datos$BARRIO, "Barrios? de Jesús", 
                                "Barrios de Jesús")
datos$BARRIO <- str_replace_all(datos$BARRIO, "Berl(í|i)n", "Berlín")
datos$BARRIO <- str_replace_all(datos$BARRIO, "L?a? ?Loma de (L|l)os Bernal", 
                                "La Loma de Los Bernal")
datos$BARRIO <- str_replace_all(datos$BARRIO, "Nueva Villa de (L|l)a Iguaná", 
                                "Nueva Villa de La Iguaná")
datos$BARRIO <- str_replace_all(datos$BARRIO, "Villa Lil?liam", 
                                "Villa Lilliam")
datos$BARRIO <- str_replace_all(datos$BARRIO, "9086", 
                                "Corregimiento de Santa Elena")
datos$BARRIO <- str_replace_all(datos$BARRIO, "6001",	
                                "Corregimiento de San Cristóbal")
x <- which(datos$BARRIO == "")
datos <- datos[-x,]
x1 <- which(datos$BARRIO == "Sin Nombre")
datos <- datos[-x1,]
datos[datos$BARRIO == "0",12] <- "Corregimiento de San Antonio de Prado"
datos$BARRIO <- str_replace_all(datos$BARRIO, "AUC1", 
                                "Cabecera Urbana San Cristobal")
datos$BARRIO <- str_replace_all(datos$BARRIO, "AUC2", 
                                "Cabecera San Antonio de Prado")
datos[datos$BARRIO == "Inst" & datos$COMUNA == "Guayabal", 12] <- "Parque Juan Pablo II"
datos[datos$BARRIO == "Inst" & datos$COMUNA == "Laureles Estadio", 12] <- "U.D. Atanasio Girardot"
datos[datos$BARRIO == "Inst" & datos$COMUNA == "La Candelaria", 12] <- "La Alpujarra"
datos$BARRIO <- str_replace_all(datos$BARRIO, "Suburbano el Tesoro", 
                                "Las Palmas")
datos <- datos[-c(datos$BARRIO == "Piedras Blancas"),]
datos$BARRIO <- str_replace_all(datos$BARRIO, "Piedras Blancas Represa", 
                                "Ocho de Marzo")
datos$BARRIO <- str_replace_all(datos$BARRIO, 
                                "Suburbano Mirador del Poblado", 
                                "Las Palmas")
datos$BARRIO <- str_replace_all(datos$BARRIO, "Suburbano Chacaltaya", 
                                "Las Palmas")
datos[datos$BARRIO == "Cabecera Urbana San Cristobal" & datos$COMUNA == "AU", 13] <- "Corregimiento de San Cristóbal"
datos[datos$BARRIO == "Cabecera San Antonio de Prado" & datos$COMUNA == "AU", 13] <- "Corregimiento de San Antonio de Prado"
datos[(datos$BARRIO == "Inst" & datos$LONGITUD == "-75.5767168" & datos$LATITUD ==	"6.2424361"), 12] <- "La Alpujarra"
datos[datos$BARRIO == "Inst" & datos$LONGITUD == "-75.58854287" & datos$LATITUD == 	"6.25412485", 12] <- "U.D. Atanasio Girardot"
datos[datos$BARRIO == "Inst" & datos$LONGITUD == "-75.58783815" & datos$LATITUD == 	"6.253239", 12] <- "U.D. Atanasio Girardot"
datos[datos$BARRIO == "Inst" & datos$LONGITUD == "-75.57765616" & datos$LATITUD == 	"6.23397437", 12] <- "Cerro Nutibara"
datos[datos$BARRIO == "Inst" & datos$LONGITUD == "-75.58738011" & datos$LATITUD == 	"6.21304744", 12] <- "Parque Juan Pablo II"
datos[datos$BARRIO == "Inst" & datos$LONGITUD == "-75.57256594" & datos$LATITUD == 	"6.28029477", 12] <- "Cementerio Universal"

#ARREGLO VARIABLE COMUNA
datos$COMUNA <- str_replace_all(datos$COMUNA, "0", 
                                "Corregimiento de San Antonio de Prado")
datos$COMUNA <- str_replace_all(datos$COMUNA, "Alejandro Echavarría", 
                                "Buenos Aires")
datos$COMUNA <- str_replace_all(datos$COMUNA, "Alfonso López", 
                                "Castilla")
datos$COMUNA <- str_replace_all(datos$COMUNA, "Altavista", 
                                "Belén")
datos$COMUNA <- str_replace_all(datos$COMUNA, "Andalucía", 
                                "Santa Cruz")
datos$COMUNA <- str_replace_all(datos$COMUNA, "Antonio Nariño", 
                                "San Javier")
datos[datos$BARRIO == "Cabecera Urbana San Cristobal" & datos$COMUNA == "AU", 13] <- "Corregimiento de San Cristóbal"
datos[datos$BARRIO == "Cabecera Urbana San Antonio de Prado" & datos$COMUNA == "AU", 13] <- "Corregimiento de San Antonio de Prado"
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "Barrio Colón", 12] <- "La Alpujarra"
datos$COMUNA <- str_replace_all(datos$COMUNA, "Barrio Colón", 
                                "La Candelaria")
datos[datos$BARRIO == "Laureles Estadio" & datos$COMUNA == "Bolivariana", 12] <- "Bolivariana"
datos$COMUNA <- str_replace_all(datos$COMUNA, "Bolivariana", 
                                "Laureles Estadio")
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "Boston", 12] <- "Boston"
datos$COMUNA <- str_replace_all(datos$COMUNA, "Boston", 
                                "La Candelaria")
datos[datos$BARRIO == "Corregimiento de San Antonio de Prado" & datos$COMUNA == "Cabecera San Antonio de Prado", 12] <- "Cabecera San Antonio de Prado"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Cabecera San Antonio de Prado", 
                                "Corregimiento de San Antonio de Prado")
datos[datos$BARRIO == "La América" & datos$COMUNA == "Calasanz", 12] <- "Calasanz"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Calasanz", 
                                "La América")
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "Calle Nueva", 12] <- "Calle Nueva"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Calle Nueva", 
                                "La Candelaria")
datos[datos$BARRIO == "Guayabal" & datos$COMUNA == "Campo Amor", 12] <- "Campo Amor"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Campo Amor", 
                                "Guayabal")
datos[datos$BARRIO == "Aranjuez" & datos$COMUNA == "Campo Valdés No.1", 12] <- "Campo Valdés No.1"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Campo Valdés No. 1", 
                                "Aranjuez")
datos[datos$BARRIO == "Manrique" & datos$COMUNA == "Campo Valdés No.2", 12] <- "Campo Valdés No.2"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Campo Valdés No. 2", 
                                "Manrique")
datos[datos$BARRIO == "Castilla" & datos$COMUNA == "Caribe", 12] <- "Caribe"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Caribe", 
                                "Castilla")
datos[datos$BARRIO == "Belén" & datos$COMUNA == "Cerro Nutibara", 12] <- "Cerro Nuribara"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Cerro Nutibara", 
                                "Belén")
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "Corazón de Jesús", 12] <- "Corazón de Jesús"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Corazón de Jesús", 
                                "La Candelaria")
datos[datos$BARRIO == "Guayabal" & datos$COMUNA == "Cristo Rey", 12] <- "Cristo Rey"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Cristo Rey", 
                                "Guayabal")
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "El Chagualo", 12] <- "El Chagualo"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "El Chagualo", 
                                "La Candelaria")
datos[datos$BARRIO == "Belén" & datos$COMUNA == "El Nogal-Los Almendros", 12] <- "El Nogal-Los Almendros"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "El Nogal-Los Almendros", 
                                "Belén")
datos[datos$BARRIO == "Manrique" & datos$COMUNA == "El Raizal", 12] <- "El Raizal"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "El Raizal", 
                                "Manrique")
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "Estación Villa", 12] <- "Estación Villa"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Estación Villa", 
                                "La Candelaria")
datos[datos$BARRIO == "Belén" & datos$COMUNA == "Fátima", 12] <- "Fátima"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Fátima", 
                                "Belén")
datos[datos$BARRIO == "Laureles Estadio" & datos$COMUNA == "Florida Nueva", 12] <- "Florida Nueva"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Florida Nueva", 
                                "Laureles Estadio")
datos[datos$BARRIO == "Castilla" & datos$COMUNA == "Girardot", 12] <- "Girardot"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Girardot", 
                                "Castilla")
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "Guayaquil", 12] <- "Guayaquil"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Guayaquil", 
                                "La Candelaria")
datos[datos$BARRIO == "Castilla" & datos$COMUNA == "Héctor Abad Gómez", 12] <- "Héctor Abad Gómez"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Héctor Abad Gómez", 
                                "Castilla")
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "Jesús Nazareno", 12] <- "Jesús Nazareno"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Jesús Nazareno", 
                                "La Candelaria")
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "La Alpujarra", 12] <- "La Alpujarra"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "La Alpujarra", 
                                "La Candelaria")
datos[datos$BARRIO == "Guayabal" & datos$COMUNA == "La Colina", 12] <- "La Colina"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "La Colina", 
                                "Guayabal")
datos[datos$BARRIO == "La América" & datos$COMUNA == "La Floresta", 12] <- "La Floresta"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "La Floresta", 
                                "La América")
datos[datos$BARRIO == "Santa Cruz" & datos$COMUNA == "La Rosa", 12] <- "La Rosa"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "La Rosa", 
                                "Santa Cruz")
datos[datos$BARRIO == "Aranjuez" & datos$COMUNA == "Las Esmeraldas", 12] <- "Las Esmeraldas"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Las Esmeraldas", 
                                "Aranjuez")
datos[datos$BARRIO == "Belén" & datos$COMUNA == "Las Playas", 12] <- "Las Playas"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Las Playas", 
                                "Belén")
datos[datos$BARRIO == "Corregimiento de Santa Elena" & datos$COMUNA == "Las Palmas", 12] <- "Las Palmas"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Las Palmas", 
                                "Corregimiento de Santa Elena")
datos[datos$BARRIO == "Manrique" & datos$COMUNA == "Las Granjas", 12] <- "Las Granjas"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Las Granjas", 
                                "Manrique")
datos[datos$BARRIO == "Laureles Estadio" & datos$COMUNA == "Laureles", 12] <- "Laureles"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Laureles", 
                                "Laureles Estadio")
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Laureles Estadio ?E?s?t?a?d?i?o?",
                                "Laureles Estadio")
datos[datos$BARRIO == "Laureles Estadio" & datos$COMUNA == "Los Conquistadores", 12] <- "Los Conquistadores"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Los Conquistadores", 
                                "Laureles Estadio")
datos[datos$BARRIO == "Villa Hermosa" & datos$COMUNA == "Los Mangos", 12] <- "Los Mangos"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Los Mangos", 
                                "Villa Hermosa")
datos[datos$BARRIO == "Castilla" & datos$COMUNA == "Oleoducto", 12] <- "Oleoducto"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Oleoducto", 
                                "Castilla")
datos[datos$BARRIO == "Laureles Estadio" & datos$COMUNA == "Naranjal", 12] <- "Naranjal"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Naranjal", 
                                "Laureles Estadio")
datos[datos$BARRIO == "Aranjuez" & datos$COMUNA == "Moravia", 12] <- "Moravia"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Moravia", 
                                "Aranjuez")
datos[datos$BARRIO == "Aranjuez" & datos$COMUNA == "Miranda", 12] <- "Miranda"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Miranda", 
                                "Aranjuez")
datos[datos$BARRIO == "El Poblado" & datos$COMUNA == "Manila", 12] <- "Manila"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Manila", 
                                "El Poblado")
datos[datos$BARRIO == "Guayabal" & datos$COMUNA == "Parque Juan Pablo II", 12] <- "Parque Juan Pablo II"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Parque Juan Pablo II", 
                                "Guayabal")
datos[datos$BARRIO == "Popular" & datos$COMUNA == "Villa Guadalupe", 12] <- "Villa Guadalupe"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Villa Guadalupe", 
                                "Popular")
datos[datos$BARRIO == "El Poblado" & datos$COMUNA == "Villa Carlota", 12] <- "Villa Carlota"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Villa Carlota", 
                                "El Poblado")
datos[datos$BARRIO == "San Javier" & datos$COMUNA == "Veinte de Julio", 12] <- "Veinte de Julio"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Veinte de Julio", 
                                "San Javier")
datos[datos$BARRIO == "Aranjuez" & datos$COMUNA == "Universidad de Antioquia", 12] <- "Universidad de Antioquia"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Universidad de Antioquia", 
                                "Aranjuez")
datos[datos$BARRIO == "Castilla" & datos$COMUNA == "Toscana", 12] <- "Toscana"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Toscana", 
                                "Castilla")
datos[datos$BARRIO == "Laureles Estadio" & datos$COMUNA == "Suramericana", 12] <- "Suramericana"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Suramericana", 
                                "Laureles Estadio")
datos[datos$BARRIO == "La América" & datos$COMUNA == "Simón Bolívar", 12] <- "Simón Bolívar"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Simón Bolívar", 
                                "La América")
datos[datos$BARRIO == "El Poblado" & datos$COMUNA == "Santa María de los Ángeles", 12] <- "Santa María de los Ángeles"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Santa María de los Ángeles", 
                                "El Poblado")
datos[datos$BARRIO == "Manrique" & datos$COMUNA == "Santa Inés", 12] <- "Santa Inés"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Santa Inés", 
                                "Manrique")
datos[datos$BARRIO == "Guayabal" & datos$COMUNA == "Santa Fé", 12] <- "Santa Fé"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Santa Fé", 
                                "Guayabal")
datos[datos$BARRIO == "Aranjuez" & datos$COMUNA == "San Pedro", 12] <- "San Pedro"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "San Pedro", 
                                "Aranjuez")
datos[datos$BARRIO == "Belén" & datos$COMUNA == "Rosales", 12] <- "Rosales"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Rosales", 
                                "Belén")
datos[datos$BARRIO == "La Candelaria" & datos$COMUNA == "Perpetuo Socorro", 12] <- "Perpetuo Socorro"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Perpetuo Socorro", 
                                "La Candelaria")
datos[datos$BARRIO == "El Poblado" & datos$COMUNA == "Patio Bonito", 12] <- "Patio Bonito"
datos$COMUNA <- str_replace_all(datos$COMUNA, 
                                "Patio Bonito", 
                                "El Poblado")
datos$COMUNA <- str_replace_all(datos$COMUNA, "Laureles Estadio ?E?s?t?a?d?i?o?", 
                                "Laureles Estadio")
datos$COMUNA <- str_replace_all(datos$COMUNA, "Corregimiento de Belén", 
                                "Corregimiento de Altavista")
datos[datos$BARRIO == "La Alpujarra" & datos$COMUNA == "In", 13] <- "La Candelaria"
datos[datos$BARRIO == "U.D. Atanasio Girardot" & datos$COMUNA == "In", 13] <- "Laureles Estadio"
datos[datos$BARRIO == "Cerro Nutibara" & datos$COMUNA == "In", 13] <- "Belén"
datos[datos$BARRIO == "Parque Juan Pablo II" & datos$COMUNA == "In", 13] <- "Guayabal"
datos[datos$BARRIO == "Cementerio Universal" & datos$COMUNA == "In", 13] <- "Castilla"
datos[datos$BARRIO == "Las Palmas" & datos$COMUNA == "La Candelaria", 13] <- "Corregimiento de Santa Elena"
datos$COMUNA <- as.character(datos$COMUNA)
datos$COMUNA <- as.factor(datos$COMUNA)
datos$BARRIO <- as.factor(datos$BARRIO)

#ARREGLO COLUMNA DIA
datos$DIA <- as.factor(datos$DIA)

#ARREGLO COLUMNA PERIODO
datos$PERIODO <- as.factor(datos$PERIODO)

#ARREGLO COLUMNA DIRECCION
datos$DIRECCION <- as.factor(datos$DIRECCION) #no es de importancia ya que tenemos los puntos de latitud y longitud
#DIRECCION_ENC no es relevante

#ELIMINAR CBML
datos <- datos[,-9]

#ARREGLO COLUMNA TIPO_GEOCOD
datos$TIPO_GEOCOD <- as.factor(datos$TIPO_GEOCOD) #PREGUNTAR AL PROFESOR IMPORTANCIA DE LA VARIABLE EN EL TRABAJO POR LO QUE SE REFIERE.

#ARREGLO DE FECHA
datos$FECHA <- as.Date(datos$FECHA)

#ARREGLO DIA_NOMBRE
datos$DIA_NOMBRE <- str_replace_all(datos$DIA_NOMBRE,"\\s", "")
datos$DIA_NOMBRE <- as.factor(datos$DIA_NOMBRE)

#ARREGLO MES
datos$MES <- as.factor(datos$MES)

#ARREGLO NOMBRE DEL MES
datos$MES_NOMBRE <- months(datos$FECHA)
datos$MES_NOMBRE <- as.factor(datos$MES_NOMBRE)

#ARREGLO DE DISEÑO
datos[datos$DISENO == "",13] <- "Otro"
datos$DISENO <- as.factor(datos$DISENO)

#ELIMINAR OBJETD YA QUE E EL ID DEL BARRIO O VEREDA
datos <- datos[,-1]

#ELIMARN VARIABLE HORA
datos <- datos[,-2]

#ELIMINAR DIRECCIONES
datos <- datos[,-c(5,6)]

#ELIMINAR TIPO_GEOCOD
datos <- datos[,-5]


#ELIMINAR VARIABLES 
datos_2018 <- datos_2018[,-c(1, 2, 3, 4, 6, 10, 11, 12, 13, 21, 22)]
datos_2018$BARRIO <- str_replace_all(datos_2018$BARRIO,
                                     "(.\\sNo\\.)\\s?(\\d)$", "\\1\\2")
x <- which(datos_2018$BARRIO == "")
datos_2018 <- datos_2018[-x,]
datos_2018$COMUNA <- str_replace_all(datos_2018$COMUNA, "AU","Corregimiento de San Cristóbal")
datos_2018$BARRIO <- str_replace_all(datos_2018$BARRIO, "AUC1", "Cabecera Urbana Corregimiento San Cristóbal")
datos_2018[datos_2018$LONGITUD == "-75.5767168" & datos_2018$LATITUD == "6.2424361", 6] <- "La Alpujarra"
datos_2018$BARRIO <- str_replace_all(datos_2018$BARRIO, "Inst", 
                                     "U.D. Atanasio Girardot")
datos_2018[datos_2018$BARRIO == "La Alpujarra" & datos_2018$COMUNA == "In", 7] <- "La Candelaria"
datos_2018$COMUNA <- str_replace_all(datos_2018$COMUNA, "In",
                                     "Laureles Estadio")
datos_2018[datos_2018$BARRIO == "6001", 6] <- "La Loma"
datos_2018[datos_2018$BARRIO == "0", 6] <- "U.D. Atanasio Girardot"
datos_2018[datos_2018$BARRIO == "0" & datos_2018$COMUNA == "Robledo", 7] <- "Laureles Estadio"

datos_2018[datos_2018$LONGITUD == "-75.61649033" & datos_2018$LATITUD == "6.22240608", 7] <- "Laureles Estadio"
datos_2018[datos_2018$LONGITUD == "-75.61649033" & datos_2018$LATITUD == "6.22240608", 6] <- "U.D. Atanasio Girardot"


datos_2018[datos_2018$LONGITUD == "-75.62157499" & datos_2018$LATITUD == "6.22172915", 7] <- "Belén"
datos_2018[datos_2018$LONGITUD == "-75.62157499" & datos_2018$LATITUD == "6.22172915", 6] <- "Cerro Nutibara"

datos_2018[datos_2018$LONGITUD == "-75.61386204" & datos_2018$LATITUD == "6.2217706", 7] <- "Guayabal"
datos_2018[datos_2018$LONGITUD == "-75.61386204" & datos_2018$LATITUD == "6.2217706", 6] <- "Parque Juan Pablo II"

datos_2018[datos_2018$LONGITUD == "-75.61525323" & datos_2018$LATITUD == "6.22232547", 6] <- "Altavista Sector Central"

datos_2018[datos_2018$LONGITUD == "-75.60717845" & datos_2018$LATITUD == "6.20749185", 6] <- "San José del Manzanillo"

datos_2018[datos_2018$LONGITUD == "-75.63555428" & datos_2018$LATITUD == "6.21827427", 6] <- "Buga Patio Bonito"

datos_2018[datos_2018$LONGITUD == "-75.61666885" & datos_2018$LATITUD == "6.22244955", 6] <- "Área de Expansión Altavista"

datos_2018[datos_2018$LONGITUD == "-75.61529455" & datos_2018$LATITUD == "6.22183086", 6] <- "El Rincón"

datos_2018[datos_2018$LONGITUD == "-75.60535248" & datos_2018$LATITUD == "6.20987334", 7] <- "Belén"
datos_2018[datos_2018$LONGITUD == "-75.60535248" & datos_2018$LATITUD == "6.20987334", 6] <- "Área de Expansión Altavista"

datos_2018[datos_2018$LONGITUD == "-75.61525323" & datos_2018$LATITUD == "6.22232547", 6] <- "La Esperanza"

datos_2018[datos_2018$LONGITUD == "-75.62464088" & datos_2018$LATITUD == "6.21985834", 6] <- "Las Palmas"
datos_2018[datos_2018$LONGITUD == "-75.62464088" & datos_2018$LATITUD == "6.21985834", 7] <- "Corregimiento de Santa Elena"

datos_2018[datos_2018$LONGITUD == "-75.54498624" & datos_2018$LATITUD == "6.20562088", 6] <- "La Esperanza"
datos_2018[datos_2018$LONGITUD == "-75.54498624" & datos_2018$LATITUD == "6.20562088", 7] <- "Corregimiento de Altavista"

datos_2018[datos_2018$LONGITUD == "-75.55537159" & datos_2018$LATITUD == "6.21848341", 6] <- "Las Palmas"

datos_2018$BARRIO <- as.factor(datos_2018$BARRIO)
datos_2018$COMUNA <- as.factor(datos_2018$COMUNA)
datos_2018$DIA <- as.factor(datos_2018$DIA)
datos_2018$PERIODO <- as.factor(datos_2018$PERIODO)
datos_2018$FECHA <- as.Date(datos_2018$FECHA)
datos_2018$CLASE <- str_replace_all(datos_2018$CLASE, "Ca(i|í)da Ocupante", "Caída Ocupante")
datos_2018$CLASE <- as.factor(datos_2018$CLASE)

datos_2018$GRAVEDAD <- as.factor(datos_2018$GRAVEDAD)
#ARREGLO DE DISEÑO
datos_2018[datos_2018$DISENO == "",8] <- "Otro"
datos_2018$DISENO <- as.factor(datos_2018$DISENO)
datos_2018$DIA_NOMBRE <- str_replace_all(datos_2018$DIA_NOMBRE,"\\s", "")
datos_2018$DIA_NOMBRE <- as.factor(datos_2018$DIA_NOMBRE)
datos_2018$MES <- as.factor(datos_2018$MES)
#ARREGLO NOMBRE DEL MES
datos_2018$MES_NOMBRE <- months(datos_2018$FECHA)
datos_2018$MES_NOMBRE <- as.factor(datos_2018$MES_NOMBRE)

datos <- rbind(datos, datos_2018)

#CREAR VARIABLE NUEVA PARA IDENTIFICAR EL NUMERO DE COMUNA 
datos$NUMEROCOMUNA <- 0
datos[datos$COMUNA == "Popular", 14] <- "1"
datos[datos$COMUNA == "Santa Cruz", 14] <- "2"
datos[datos$COMUNA == "Manrique", 14] <- "3"
datos[datos$COMUNA == "Aranjuez", 14] <- "4"
datos[datos$COMUNA == "Castilla", 14] <- "5"
datos[datos$COMUNA == "Doce de Octubre", 14] <- "6"
datos[datos$COMUNA == "Robledo", 14] <- "7"
datos[datos$COMUNA == "Villa Hermosa", 14] <- "8"
datos[datos$COMUNA == "Buenos Aires", 14] <- "9"
datos[datos$COMUNA == "La Candelaria", 14] <- "10"
datos[datos$COMUNA == "Laureles Estadio", 14] <- "11"
datos[datos$COMUNA == "La América", 14] <- "12"
datos[datos$COMUNA == "San Javier", 14] <- "13"
datos[datos$COMUNA == "El Poblado", 14] <- "14"
datos[datos$COMUNA == "Guayabal", 14] <- "15"
datos[datos$COMUNA == "Belén", 14] <- "16"
datos[datos$COMUNA == "Corregimiento de San Sebastián de Palmitas", 14] <- "50"
datos[datos$COMUNA == "Corregimiento de San Cristóbal", 14] <- "60"
datos[datos$COMUNA == "Corregimiento de Altavista", 14] <- "70"
datos[datos$COMUNA == "Corregimiento de San Antonio de Prado", 14] <- "80"
datos[datos$COMUNA == "Corregimiento de Santa Elena", 14] <- "90"
datos$DIA_NOMBRE <- capitalize(tolower(datos$DIA_NOMBRE))
datos$MES_NOMBRE <- capitalize(datos$MES_NOMBRE)
datos$GRAVEDAD <- capitalize(tolower(datos$GRAVEDAD))

#CREACIÓN VARIABLE SEMANA
datos$SEMANA <- as.factor(week(datos$FECHA))

#CREACION DE LA VARIABLE DIA
datos$DIAAÑO <- lubridate::yday(datos$FECHA)

# Se crea la lista de valores para cada fila de 'datos'
holidays_l <- apply(datos,1,function(x){
  holiday <- subset(holidays, (year == x["PERIODO"] & day == x["DIA"] & month == x["MES"]), select=c(celebration,is_holiday))
  
  if(nrow(holiday) > 0){ # Se revisa que en la fecha del accidente haya un registro en el df 'holidays'
    holiday <- holiday[1,]
    is_holiday <- 
    return(c(1,holiday$is_holiday,holiday$celebration)) 
    # Se devuelve una lista conteniendo el DIA ESPECIAL, FESTIVO y el nombre de la celebración
  }else{
    # Valores nulos en caso de que no se encuentre un registro
    return(c(0,0,"Día Normal"))
  }
})

# Se obtiene la transpuesta de la matrix, para ingresarla como dataframe
holidays_t <- t(holidays_l)

holidays_df <- data.frame(holidays_t)
colnames(holidays_df) <- c("DIA_ESPECIAL", "DIA_FESTIVO", "CELEBRACION")

# Se agregan las columnas al DataFrame de 'datos'
datos$SEMANA <- str_replace_all(datos$SEMANA, "53", "52")
datos <- cbind(datos, holidays_df)
summary(datos)
```

```{r}
DIARIOS <- datos %>% group_by(CLASE, FECHA, DIA_ESPECIAL) %>% count(name = "NRO_ACC_DIA")

DIASEMANA <- datos %>% group_by(PERIODO, CLASE, BARRIO, GRAVEDAD, COMUNA, NUMEROCOMUNA,
                                DIA_NOMBRE, MES, DIA_ESPECIAL, DIA_FESTIVO,
                                CELEBRACION) %>% count(name = "NRI_ACC_DIANOMBRE")
```

```{r}
SEMANAL <- datos %>% group_by(PERIODO, CLASE,BARRIO,GRAVEDAD, COMUNA,NUMEROCOMUNA, SEMANA, DIA_ESPECIAL, DIA_FESTIVO, CELEBRACION) %>% count(name = "NRO_ACC_SEMANA")
```

```{r}
MENSUAL <- datos %>% group_by(CLASE, MES) %>% count(name = "NRO_ACC_MES")
```

## Análisis exploratorio
```{r}
porcentaje <- function(x){
  (x*100)/208922
}
mis.colores <- colorRampPalette(c("blue", "red"))
```

```{r echo=FALSE}
Comuna <- datos %>% group_by(COMUNA) %>% count()
Comuna$Porcentaje <- round(porcentaje(Comuna$n),2)
Comuna <- Comuna %>% arrange(desc(Porcentaje), COMUNA)

ggplot(Comuna, aes(x = reorder(COMUNA, Porcentaje), y = Porcentaje, 
                   fill = reorder(COMUNA, Porcentaje))) + 
  geom_bar(stat="identity", show.legend = F) + 
  coord_flip() + 
  scale_fill_manual(values=mis.colores(21)) + 
  xlab("Comuna") + 
  ylab("Porcentaje [%]") + 
  ggtitle("Porcentaje de Accidentalidad por Comuna")



```

Se observa que la comuna con mayor accidentalidad es La Candelaria que representa aproximadamente el 21%, las comunas Belén y Robledo cada una con $\approx$ 7%,  La América y Manrique poseen comportamientos similares cada una representa $\approx$ 4% de la población,  Doce de Octubre y Villa Hermosa presentan comportamientos similares con  $\approx$ 3% cada una, Popular y Santa Cruz representan un 1.5% de la población, finalmente el Corregimiento de San Sebastián de Palmitas representa un 0.01% lo que indica que presenta la menor cantidad de accidentes, por tanto no es representativo. 



```{r}
barrio <- datos %>% group_by(BARRIO) %>% count()
barrio$Porcentaje <- round(porcentaje(barrio$n),2)
barrio <- barrio %>% arrange(desc(Porcentaje), BARRIO)
topbarrio <- barrio[1:22, ]
ggplot(topbarrio, aes(x = reorder(BARRIO, Porcentaje), y = Porcentaje, 
                   fill = reorder(BARRIO, Porcentaje))) + 
  geom_bar(stat="identity", show.legend = F) + 
  coord_flip() + 
  scale_fill_manual(values=mis.colores(22)) + 
  xlab("Barrio") + 
  ylab("Porcentaje [%]") + 
  ggtitle("Porcentaje de Accidentalidad por barrio")
```

En los registros del conjunto de datos existen 307 barrios, para la construcción de este gráfico solo se consideraron los 22 barrios con más accidentalidad, ya que los restantes (285) no llegan a representar el 1% del total de accidentes que se presenta en la ciudad de Medellín. 
El barrio la candelaria presenta el mayor porcentaje de accidentalidad en todos los barrios de Medellín; Barrio Colón y San Benito presentan $\approx$ 1.6% de accidentalidad cada uno; Terminal de Transporte y Villa Nueva presentan comportamientos similares ya que cada uno representa el 1.4% del total de la población; Corazón de Jesús, Belén y Guayabal representan 1.2% cada uno; finalmente los barrios Villa Carlota y Chagualo son $\approx$ 1%. 


```{r echo=FALSE, message=FALSE, warning=FALSE}
conteo <- datos %>% group_by(PERIODO, MES) %>% count()
accidentes <- conteo$n

a1 <- datos %>% group_by(BARRIO) %>% count()
heat <- data.frame(row.names = str_to_title(unique(datos$MES_NOMBRE)),
                   '2014' = accidentes[1:12],
                   "2015" = accidentes[13:24],
                   "2016" = accidentes[25:36],
                   "2017" = accidentes[37:48],
                   "2018" = accidentes[49:60])
heat <- as.matrix((heat))
Colors=c("blue", "red")
Colors=colorRampPalette(Colors)(100)
heatmap.2(t(heat),
          scale= "none",
          Colv = NA,
          Rowv = NA, 
          labRow = c("2014","2015", "2016", "2017", "2018"),
          trace = "none", 
          density.info = "none",
          col = Colors,
          margin= c(7,7),
          srtCol=45,
          main = "Accidentes por año y mes",
          xlab= "Mes",
          ylab = "Año",
          
          )
```

En el mes de Enero se presenta la menor cantidad de accidentes para todos los años considerados, el mes de Marzo presento una alta accidentalidad unicamente en el año 2014, en general el mes de Agosto es el mes con mayor accidentes pero fue aún más grave para los años 2016 y 2017, finalmente se observa que el mes de Octubre presento gran acidentalidad para el año 2016, los meses de Junio y Noviembre presentan comportamientos semejantes, el año con mayor cantidad de accidentes es 2016 y el año de menor accidentalidad fue 2018.

```{r echo=FALSE}
Mes <- datos %>% group_by(MES_NOMBRE) %>% count()
Mes$Porcentaje <- round(porcentaje(Mes$n),2)
Mes <- Mes %>% arrange(desc(Porcentaje), MES_NOMBRE)
ggplot(Mes, aes(x = reorder(MES_NOMBRE, Porcentaje), y = Porcentaje, 
                   fill = reorder(MES_NOMBRE, Porcentaje))) + 
  geom_bar(stat="identity", show.legend = F) + 
  coord_flip() + 
  scale_fill_manual(values=mis.colores(12)) + 
  xlab("Mes") + 
  ylab("Porcentaje [%]") + 
  ggtitle("Porcentaje de Accidentalidad por mes")
```

El mes que presenta mayor accidentalidad es Agosto con 8.93% cabe resaltar que este mes se derrolla la tradicional Feria de Flores de Medellín, los meses Septiembre, Mayo, Marzo, Julio y Octubre tienen un comportamiento muy similar con $\approx$ 8.6% cada uno, Noviembre, Febrero y Junio también se comportan de manera semejante con $\approx$ 8% cda uno; finalmente el mes de Enero presenta la menor cantidad de accidentes, esto puede deberse a que la mayoría de personas se encuentran fuera de la ciudad por vacaciones. 

```{r echo=FALSE, fig.align='center'}
knitr::include_graphics("Graph.svg")
```
se confirma que las primeras semanas del año presentan la menor accidentalidad, los días 10 y 14 de Marzo son los más accidentados, los días 30 y 31 de Octubre se presenta gran cantodad de accidentes, entre los días 11 a 18 de Septimebre también se presenta una cantidad alta de incidentes viales esto puede deberse a las celebraciones de amor y amistad, desde el 16 al 23 de Diciembre hay fuerte accidentalidad esto se corrobora con el gráfico semanal.

```{r}
semana <- datos %>% group_by(SEMANA) %>% count()
semana$Porcentaje <- round(porcentaje(semana$n),2)
semana <- semana%>% arrange(desc(Porcentaje), SEMANA)
semana <- semana[c(1:10, 42:52), ]
mis.colores <- colorRampPalette(c("blue", "red"))
ggplot(semana, aes(x = reorder(SEMANA, Porcentaje), y = Porcentaje, 
                   fill = reorder(SEMANA, Porcentaje))) + 
  geom_bar(stat="identity", show.legend = F, position = "dodge") + 
  coord_flip() + 
  scale_fill_manual(values=mis.colores(21)) + 
  xlab("Semana") + 
  ylab("Porcentaje [%]") + 
  ggtitle("Porcentaje de Accidentalidad por semana")
```

La semana 31 que va desde el 29 Julio al 05 de Agosto posee la mayor accidentalidad esto puede deberse a Feria de Flores; sigue la semana 51 comprendida entre el 17 y 23 de Diciembre, la accidentalidad presentada en esta semana puede deberse a las celebraciones de este mes, finalmente se observa que la dos primeras semanas del año son las menos accidentadas. Para este análisis se decidio juntar las semanas 52 y 53 ya que esta última solo comprendia dos días.

```{r}
Diasemana <- datos %>% group_by(DIA_NOMBRE) %>% count()
Diasemana$Porcentaje <- round(porcentaje(Diasemana$n),2)
Diasemana <- Diasemana %>% arrange(desc(Porcentaje), DIA_NOMBRE)
ggplot(Diasemana, aes(x = reorder(DIA_NOMBRE, Porcentaje), y = Porcentaje, 
                   fill = reorder(DIA_NOMBRE, Porcentaje))) + 
  geom_bar(stat="identity", show.legend = F) + 
  coord_flip() + 
  scale_fill_manual(values=mis.colores(7)) + 
  xlab("Día de la semana") + 
  ylab("Porcentaje [%]") + 
  ggtitle("Porcentaje de Accidentalidad por día")
```

Los días Viernes y Martes se presenta la mayor cantidad de accidentes, para el día Viernes esto puede ser ocasionado por el inicio del fin de semana, repecto al día Martes se presenta un comportamiento poco esperado, se puede presentar por múltiples razones algunas de ellas los días festivos y el aforo vehicular por día. El Domingo se presenta 9.5% de accidentes, el menor de todos se siguiere que esto sucede por ser el día de descanso de la mayoría de las personas. 

```{r}
clase <- datos %>% group_by(CLASE) %>% count()
clase$Porcentaje <- round(porcentaje(clase$n),2)
clase <- clase %>% arrange(desc(Porcentaje), CLASE)
ggplot(clase, aes(x = reorder(CLASE, Porcentaje), y = Porcentaje, 
                   fill = reorder(CLASE, Porcentaje))) + 
  geom_bar(stat="identity", show.legend = F) + 
  coord_flip() + 
  scale_fill_manual(values=mis.colores(6)) + 
  xlab("Clase del accidente") + 
  ylab("Porcentaje [%]") + 
  ggtitle("Porcentaje de Accidentalidad por clase")
```

El tipo más frecuente de accidente es Choque con alrededor de 67%, Incendio representa el 0.01% del total de la población, por tanto no es significativo.

```{r echo=FALSE}
clasegravedad <- datos %>% group_by(CLASE, GRAVEDAD) %>% count()
clasegravedad <- clasegravedad %>% arrange(CLASE, GRAVEDAD)
mis.colores <- c("#D0002E", "#8B0073","#4500B9")
ggplot(clasegravedad, aes(x = reorder(CLASE, -n), y = n, 
                   fill = reorder(GRAVEDAD, -n))) + 
  geom_bar(stat="identity", show.legend = T, position = "fill") + 
  scale_fill_manual(values=mis.colores) + 
  xlab("Clase del accidente") + 
  ylab("Porcentaje [%]") + 
  guides(fill=guide_legend(title="Gravedad")) + 
  ggtitle("Porcentaje de Accidentalidad por clase y gravedad")
```
```{r}
ggplot(clase, aes(x = reorder(CLASE, -n), y = n, 
                   fill = reorder(CLASE, n))) + 
  geom_bar(stat="identity", show.legend = F) + 
  scale_fill_manual(values=mis.colores(6)) + 
  xlab("Clase del accidente") + 
  ylab("Porcentaje [%]") + 
  ggtitle("Porcentaje de Accidentalidad por clase")
```

El tipo de accidente Choque en su gran mayoría deja como consecuencia Solo daños alrededor de un 70%, el 30% restante corresponde a Heridos; la clase Atropello y Caída Ocupante en su gran mayoría dejan Heridos con un porcentaje muy bajo de Muertes; respecto a Volcamiento y Otro 

```{r eval=FALSE, include=FALSE}
diseñovia <- datos %>% group_by(DISENO) %>% count()
diseñovia$Porcentaje <- round(porcentaje(diseñovia$n),2)
diseñovia <- diseñovia %>% arrange(desc(Porcentaje), DISENO)
ggplot(diseñovia, aes(x = reorder(DISENO, Porcentaje), y = Porcentaje, 
                   fill = DISENO)) + 
  geom_bar(stat="identity", show.legend = F) + 
  scale_fill_manual(values=mis.colores(13)) + 
  coord_flip() + 
  xlab("Diseño de la vía") + 
  ylab("Porcentaje [%]") + 
  ggtitle("Porcentaje de Accidentalidad por diseño de la vía")
```
La gran parte de los accidentes en la ciudad de Medellín ocurren en Tramo de Via e Intersecciones, algo que es de esperarse ya que estas Intersecciones son de alta preligrosidad. 

## Datos históricos

```{r}
historicos <- datos %>% group_by(PERIODO, MES_NOMBRE, MES, CLASE) %>% 
  count() %>% mutate(MES=as.integer(MES))


data2014 <- historicos[lubridate::year(historicos$FECHA) %in% c(2014), ]
data2015 <- historicos[lubridate::year(historicos$FECHA) %in% c(2015), ]
data2016 <- historicos[lubridate::year(historicos$FECHA) %in% c(2016), ]
data2017 <- historicos[lubridate::year(historicos$FECHA) %in% c(2017), ]
data2018 <- historicos[lubridate::year(historicos$FECHA) %in% c(2018), ]
```

```{r}
for (Clase in unique(historicos$CLASE)) {
  p <- ggplot(historicos[historicos$CLASE == Clase, ], 
       aes(x=MES, y=n, col=PERIODO)) + 
  labs(x = "Mes", y="Cantidad de accidentes", col="Año",
       title = paste("Cantidad de accidentes de la clase", Clase, "por mes")) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(1,12,1))
  print(p)
}

```


## wordcloud
```{r}
datosWordC <- str_replace_all(datos$COMUNA, "\\s", "-")
wordcloud(datosWordC,colors=brewer.pal(6,"Dark2"),random.order=FALSE)
```

# Planteamiento de modelos
## Hasta acá datos tiene los datos de los años 2014-2017, lo que se usará para el entrenamiento, y se usaran los datos de 2018 para validación

```{r}
datos_vl <- subset(datos, (PERIODO == '2018'))
datos_tr <- subset(datos, (PERIODO != '2018'))
```

# Se corre un modelo lineal teniendo en cuenta las variables de DIA_ESPECIAL, DIA_NOMBRE, DISENO
```{r}
# Agrupación de los datos para el modelo lineal, cada registro contiene las condiciones únicas de las 4 columnas,y se agrega la variable ded 'NRO_ACC', que son el número de accidentes cuando se cumplen esas condiciones
datos_lm1 <- datos_tr %>% group_by(FECHA, DIA_ESPECIAL, DIA_NOMBRE, DISENO) %>% count(name = "NRO_ACC") 
lm1 <- lm(NRO_ACC ~ DIA_ESPECIAL+DIA_NOMBRE+DISENO, data = datos_lm1) # Modelo lineal

summary(lm1) # Se observa que el modelo lineal tiene un buen ajuste de R-cuadrado
```
# El análisis de significancia obtenido por el 'summary' sugiere que las variables DIA_ESPECIAL, y DIA_NOMBRE son de mucha
# significancia

```{r}
# Se crea el conjunto de datos para la validación

lm1_2018 <- datos_vl %>% group_by(FECHA, DIA_ESPECIAL, DIA_NOMBRE, DISENO) %>% count(name = "NRO_ACC")


predicted <- round(predict(lm1, newdata=lm1_2018))
actual <- lm1_2018$NRO_ACC

lm1_mse <- MSE(predicted, actual) # MSE
lm1_mae <- MAE(predicted, actual) # MAE
lm1_r2 <- R2_Score(predicted, actual) # R2

sprintf("MSE: %f, MAE: %f, R2: %f", lm1_mse, lm1_mae, lm1_r2)
```
# El primer modelo tiene buenas métricas, a excepción de la diferencia entre los R2 que indica que existe un sobre ajuste, pero #tiene un problema al tener la variable DISENO, ya que no tenemos una forma fácil de obtener esta variable para la predicción

```{r}
# Modelo a partir del anterior teniendo en cuenta el DIA_FESTIVO y no DÍA ESPECIAL
datos_lm2 <- datos_tr %>% group_by(FECHA,DIA_FESTIVO, DIA_NOMBRE, DISENO) %>% count(name = "NRO_ACC")
lm2 <- lm(NRO_ACC ~ DIA_FESTIVO+DIA_NOMBRE+DISENO, data = datos_lm2)

summary(lm2)

```

```{r}
lm2_2018 <- datos_vl %>% group_by(FECHA,DIA_FESTIVO, DIA_NOMBRE, DISENO) %>% count(name = "NRO_ACC")

predicted <- round(predict(lm2, newdata=lm2_2018))
actual <- lm2_2018$NRO_ACC

lm2_mse <- MSE(predicted, actual) # MSE
lm2_mae <- MAE(predicted, actual) # MAE
lm2_r2 <- R2_Score(predicted, actual) # R2

sprintf("MSE: %f, MAE: %f, R2: %f", lm2_mse, lm2_mae, lm2_r2)
```

```{r}
# Modelo lineal sin la variable DISENO
datos_lm3 <- datos_tr %>% group_by(FECHA,DIA_FESTIVO, DIA_NOMBRE) %>% count(name = "NRO_ACC")
lm3 <- lm(NRO_ACC ~ DIA_FESTIVO+DIA_NOMBRE, data = datos_lm3)

summary(lm3)
```
# Se puede notar que el R2 Ajustado baja drásticamente al quitar la variable DISENO

```{r}
lm3_2018 <- datos_vl %>% group_by(FECHA,DIA_FESTIVO, DIA_NOMBRE) %>% count(name = "NRO_ACC")

predicted <- round(predict(lm3, newdata=lm3_2018))
actual <- lm3_2018$NRO_ACC

lm3_mse <- MSE(predicted, actual) # MSE
lm3_mae <- MAE(predicted, actual) # MAE
lm3_r2 <- R2_Score(predicted, actual) # R2

sprintf("MSE: %f, MAE: %f, R2: %f", lm3_mse, lm3_mae, lm3_r2)
```
# Al quitar la variable las métricas de validación también empeoran

# Se intenta ahora con un modelo lineal generalizado, considerando las variables DIA_NOMBRE, DIA_FESTIVO 
```{r}
datos_lm4 <- datos_tr %>% group_by(FECHA,DIA_FESTIVO, DIA_NOMBRE) %>% count(name = "NRO_ACC")
lm4 <- glm(NRO_ACC ~ DIA_FESTIVO+DIA_NOMBRE, family = "poisson", data = datos_lm4) # Modelo lineal generalizado, con familia poisson
summary(lm4)
```

```{r}
lm4_2018 <- datos_vl %>% group_by(FECHA,DIA_FESTIVO, DIA_NOMBRE) %>% count(name = "NRO_ACC")

predicted <- round(predict(lm4, newdata=lm4_2018, type="response")) # Se usa type= 'response' por ser una regresion logística
actual <- lm4_2018$NRO_ACC

lm4_mse <- MSE(predicted, actual) # MSE
lm4_mae <- MAE(predicted, actual) # MAE
lm4_r2 <- R2_Score(predicted, actual) # Pseudo R2

sprintf("MSE: %f, MAE: %f, Pseudo R2: %f", lm4_mse, lm4_mae, lm4_r2)
```
# El anterior consituye un modelo logístico similar al modelo lineal # 3, a partir de este se ira puliendo
# Se agrega la variable clase al siguiente modelo, ya que es necesario predecir el número de accidentes según el tipo
# Según la salida obtenida, todas las variables son significantes.
```{r}
# Modelo linealk generalizado, agregando la variable Clase
datos_lm5 <- datos_tr %>% group_by(FECHA,DIA_FESTIVO, DIA_NOMBRE,CLASE) %>% count(name = "NRO_ACC")
lm5 <- glm(NRO_ACC ~ DIA_FESTIVO+DIA_NOMBRE+CLASE, family = "poisson", data = datos_lm5)
summary(lm5)
```

```{r}
# Análisis sobre los coeficientes
exp_c <- exp(lm5$coefficients)
exp_c

# Los días Festivos tienen aproximadamente 0.56 veces el número promedio de accidentes de un día normal
# El número promedio de Accidentes de Los días Jueves es aproximadamente 1.59 veces el número de accidentes de un Domingo
# El número promedio de Accidentes de Los días Lunes es aproximadamente 1.63 veces el número de accidentes de un Domingo
# El número promedio de Accidentes de Los días Martes es aproximadamente 1.62 veces el número de accidentes de un Domingo
# El número promedio de Accidentes de Los días Miércoles es aproximadamente 1.58 veces el número de accidentes de un Domingo
# El número promedio de Accidentes de Los días Sábado es aproximadamente 1.49 veces el número de accidentes de un Domingo
# El número promedio de Accidentes de Los días Viernes es aproximadamente 1.49 veces el número de accidentes de un Domingo
# El número promedio de Accidentes que son 'Caída Ocupante' es aproximadamente 0.87 veces el número de accidentes que son 'Atropello'
# El número promedio de Accidentes que son 'Choque' es aproximadamente 6.62 veces el número de accidentes que son 'Atropello'
# El número promedio de Accidentes que son 'Incendio' es aproximadamente 0.086 veces el número de accidentes que son 'Atropello'
# El número promedio de Accidentes que son 'Volcamiento' es aproximadamente 0.34 veces el número de accidentes que son 'Atropello'
# El número promedio de Accidentes que son 'Otro' es aproximadamente 1.07 veces el número de accidentes que son 'Atropello'

```


# El modelo se comporta bien porque:
# - El R2 de Entrenamiento, calculado con la función 'custom_R2' tiene un buen valor, que significa que
#   el modelo explica el 93% de la variabilidad del número de accidentes por día, de una clase en especifico
#   en el Valle de Aburrá
# - La sobredispersión del modelo se encuentra en un valor cercano a 1, es decir, la sobredispersión de los
#   datos frente al modelo es baja, indicando un ajuste razonable del modelo.
```{r}
# Se computan métricas de entrenamiento
y_train <- round(predict(lm5, newdata= datos_lm5, type="response"))
y_actual <- datos_lm5$NRO_ACC
lm5_tmse <- MSE(y_train, y_actual)
lm5_tmae <-  MAE(y_train, y_actual)
lm5_tr2 <- custom_R2(lm5)
lm5_rel <- lm5$deviance/lm5$df.residual # Se obtiene la sobredispersion
sprintf("Entrenamiento, MSE: %f, MAE: %f, R2 Entrenamiento: %f, Sobredispersión: %f", lm5_tmse, lm5_tmae, lm5_tr2,lm5_rel)
```

```{r}
lm5_2018 <- datos_vl %>% group_by(FECHA,DIA_FESTIVO, DIA_NOMBRE,CLASE) %>% count(name = "NRO_ACC")

predicted <- round(predict(lm5, newdata=lm5_2018, type="response")) # Se usa type= 'response' por ser una regresion logística
actual <- lm5_2018$NRO_ACC

lm5_mse <- MSE(predicted, actual) # MSE
lm5_mae <- MAE(predicted, actual) # MAE
lm5_r2 <- R2_Score(predicted, actual) # Pseudo R2

sprintf("MSE: %f, MAE: %f, Pseudo R2: %f", lm5_mse, lm5_mae, lm5_r2)
```
# Este modelo da resultados bastantes prometedores en las métricas utilizadas

```{r}
# Por ahora nos quedamos con el Modelo 5 que ha mostrado los mejores resultados y computamos más métricas

# Suma de los cuadrados de los residuales

lm5_2018$predicted <- predicted

# TO DO: Mejorar esta gráfica
lm5_plot <- ggplot(lm5_2018[1:50,]) + geom_point(mapping = aes(c(1:50),NRO_ACC, col="Reales")) + geom_line(mapping = aes(c(1:50),NRO_ACC, col="Reales")) + geom_point(mapping = aes(c(1:50),predicted, col="Predichos")) + geom_line(mapping = aes(c(1:50),predicted, col="Predichos")) + scale_color_manual("Datos", values = c("Predichos" = "red", "Reales" = "darkgreen"))

lm5_plot + ggtitle("Accidentalidad en 2018", subtitle="Clase, Dia Festivo, Dia de la Semana (50 Registros)")+ ylab("No. de Accidentes") + xlab("Registros")

```
# Por ahora este es un buen modelo
```{r}
plot(lm5)
```

```{r}
w <- abs(rstudent(lm5)) < 5 & abs(cooks.distance(lm5)) < 4/nrow(lm5$model)
lm6 <- update(lm5, weights=as.numeric(w))
```

```{r}
summary(lm6)
```

```{r}
# Se computan métricas de entrenamiento
y_train <- round(predict(lm6, newdata= datos_lm5, type="response"))
y_actual <- datos_lm5$NRO_ACC
lm6_tmse <- MSE(y_train, y_actual)
lm6_tmae <-  MAE(y_train, y_actual)
lm6_tr2 <- R2_Score(y_train, y_actual)
sprintf("Entrenamiento, MSE: %f, MAE: %f, Pseudo R2: %f", lm6_tmse, lm6_tmae, lm6_tr2)
```

```{r}
predicted <- round(predict(lm6, newdata=lm5_2018, type="response")) # Se usa type= 'response' por ser una regresion logística
actual <- lm5_2018$NRO_ACC

lm6_mse <- MSE(predicted, actual) # MSE
lm6_mae <- MAE(predicted, actual) # MAE
lm6_r2 <- R2_Score(predicted, actual) # Pseudo R2

sprintf("MSE: %f, MAE: %f, Pseudo R2: %f", lm6_mse, lm6_mae, lm6_r2)
```
```{r}
# Modelo lineal con la misma fórmula y datos del modelo lineal generalizado (lm5)
lm7 <- lm(NRO_ACC ~ DIA_FESTIVO+DIA_NOMBRE+CLASE, data = datos_lm5)
summary(lm7)
```
# La regresión lineal aunque buena, no mejora los resultados del modelo 5
```{r}
predicted <- round(predict(lm7, newdata=lm5_2018)) 
actual <- lm5_2018$NRO_ACC

lm7_mse <- MSE(predicted, actual) # MSE
lm7_mae <- MAE(predicted, actual) # MAE
lm7_r2 <- R2_Score(predicted, actual) # R2

sprintf("MSE: %f, MAE: %f, R2: %f", lm7_mse, lm7_mae, lm7_r2)
```

# Se decide que se usará el Modelo #5, que consiste en un modelo lineal generalizado, de la familia poisson
# Con las variables CLASE, DIA_NORMAL, DIA_FESTIVO
```{r}
datos_model <- datos %>% group_by(FECHA,DIA_FESTIVO, DIA_NOMBRE,CLASE) %>% count(name = "NRO_ACC") #Tomar todos los datos

model <- glm(NRO_ACC ~ DIA_FESTIVO+DIA_NOMBRE+CLASE, family = "poisson", data = datos_model)
summary(model)
```

```{r}
# Se computan métricas de entrenamiento
y_train <- round(predict(model, newdata= datos_model, type="response"))
y_actual <- datos_model$NRO_ACC
model_tmse <- MSE(y_train, y_actual)
model_tmae <-  MAE(y_train, y_actual)
model_tr2 <- custom_R2(lm5)
model_rel <- model$deviance/model$df.residual # Se obtiene la sobredispersion
sprintf("Entrenamiento, MSE: %f, MAE: %f, R2 Entrenamiento: %f, Sobredispersión: %f", model_tmse, model_tmae, model_tr2,model_rel)

# De no poder agregarse los datos del 2018 para entrenar el modelo final, usar esto
# model <- lm5
```

```{r}
#Guardar el modelo para su uso en la aplicación

save(model, file="model.RData")
```

```{r}

# Generar el set de datos que usará en producción
start <- as.Date("2019-01-01")
end <- as.Date("2020-12-31")
dates19_20 <- seq.Date(from = start, to = end, by = 1)
holidays19_20 <-read.csv("./BasesDeDatos/holidays2019-2020.csv", header = T, sep=",", encoding = "UTF-8")

# Función para resolver los nombres de la semana en inglés al español
weekdays_es <- function(weekday_en){
  if (weekday_en == 'Monday'){
    return("Lunes")
  }else if(weekday_en == 'Tuesday'){
    return("Martes")
  }else if(weekday_en == 'Wednesday'){
    return("Miércoles")
  }else if(weekday_en == 'Thursday'){
    return("Jueves")
  }else if(weekday_en == 'Friday'){
    return("Viernes")
  }else if(weekday_en == 'Saturday'){
    return("Sábado")
  }else if(weekday_en == 'Sunday'){
    return("Domingo")
  }
}
```

```{r}
days_prod <- sapply(dates19_20,function(x_date){
  holiday <- subset(holidays19_20, (date == format(x_date,"%Y-%m-%d")), select=c(celebration,is_holiday))
  
  if(nrow(holiday) > 0){ # Se revisa que en la fecha del accidente haya un registro en el df 'holidays'
    return(c(format(x_date,"%Y-%m-%d"),1,weekdays_es(weekdays(x_date)))) 
    # Se devuelve una lista conteniendo el DIA ESPECIAL, FESTIVO y el nombre de la celebración
  }else{
    # Valores nulos en caso de que no se encuentre un registro
    return(c(format(x_date,"%Y-%m-%d"),0,weekdays_es(weekdays(x_date))))
  }
})

# Se obtiene la transpuesta de la matrix, para ingresarla como dataframe

days_prod <- t(days_prod)
days_df <- data.frame(days_prod)
colnames(days_df) <- c("FECHA", "DIA_FESTIVO", "DIA_NOMBRE")
clases <- levels(datos_model$CLASE)
```



```{r}
save(days_df, file="days_df.RData")
save(clases, file="clases.RData")
```











